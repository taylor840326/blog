## 重新生成K8S Token
-----

## 1. 简介

使用kubeadm token create生成的token是有过期时间的。

过期以后需要重新签发token才能让新节点加入到现有的kubernetes集群中。

通过如果token过期后，在执行kubeadm join的时候报错如下

```txt
k8s Could not find a JWS signature in the cluster-info ConfigMap for token ID "vezzap"
```

这个错误的原因是没有token

```txt
kubeadm join —
error execution phase preflight: couldn’t validate the identity of the API Server: abort connecting to API servers after timeout of 5m0s
```

这个错误的原因是token失效

以上两种情况都需要重新生成token。

## 2. 重新生成Token步骤

Kubernetes集群初始化后，Token在24小时后就会失效。

如果到了token失效时间从节点再加入集群，需要重新生产token。

### 2.1. 查看token状态

在主节点上执行如下命令查看token的信息

```bash
# kubeadm token list
TOKEN TTL EXPIRES USAGES DESCRIPTION EXTRA GROUPS
5ti5kd.o32bm9lofv6zej94 21h 2019-05-22T11:16:31+08:00 authentication,signing The default bootstrap token generated by 'kubeadm init'. system:bootstrappers:kubeadm:default-node-token
```

### 2.2. 重新生成token

在主节点上执行如下命令重新生成Token

```bash
# kubeadm token create
　　W0511 05:25:48.747429 31569 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]

lb2hib.5kf3zjrzkp8e632w
```

### 2.3. 获取--discovery-token-ca-cert-hash值

在主节点上执行如下命令获取Token的ca认证hash值

```bash
# openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'

4fcac7c487209d7c354351ba6f93110253df4d0440fc68cb23fc4ac0baed4e0c
```


## 3. 使用新Token加入集群

在新从节点上执行如下命令使用新Token加入到Kubernetes集群

```bash
# kubeadm join 192.168.1.106:6443 --token hb0mhv.5kf3zjrzkp8e632w --discovery-token-ca-cert-hash sha256:cd778ad01bdbc656eaff7d3b1273691f0070ebbadd2f1b8a3189a6dc1e88f39f
```

**注意:** 

需要替换两个位置的值

第一个位置替换:lb2hib.5kf3zjrzkp8e632w

第二个位置替换:4fcac7c487209d7c354351ba6f93110253df4d0440fc68cb23fc4ac0baed4e0c
## 分布式搜索及内部算分

-----

### 1. 分布式搜索的运行机制

Elasticsearch的搜索，会分两阶段进行。

1. Query
1. Fetch


### Query阶段

用户发出搜索请求到ES节点。节点收到请求后，会以Coordinating节点的身份，在6个主副分片中随机选择3个分片，发送查询请求。

被选中的分片执行查询，进行排序。然后，每个分片都会返回From + Size个排序后的文档ID和排序值给Coordinating节点

### Fetch节点

Coordinating Node会将Query阶段从每个分片获取的排序后的文档id列表重新进行排序。选取From到From+ Size个文档的id

以multiget请求的方式，到相应的分片获取详细的文档数据。


### Query Then Fetch潜在的问题

**性能问题**

每个分片上需要查询的文档个数 = from + size

最终协调节点需要处理： number_of_shard * (from + size)

深度分页

**相关性算分**

每个分片都基于自己的分片上的数据进行相关度算分。这会导致打分偏离的情况，特别是数据量很少时。

相关性算分在分片之间时相互独立的。

当文档总数很少的情况下，如果主分片大于1，主分片数越多，相关性算分会越不准。

### 解决算分不准的方法

1. 数据量不大的时候，可以将主分片数设置为1
    当数据量足够大的时候，只要保证文档均匀分散在各个分片上，结果一般就不会出现偏差。
1. 使用DFS Query Then Fetch
    搜索的URL中指定参数"_search?search_type=dfs_query_then_fetch"
    到每个分片把各分片的词频和文档频率进行搜集，然后完整的进行一次相关性算分，耗费更加多的CPU和内存。执行性能低下，一般不建议使用


